/* user-quan/3.0.0 common.js Date:2017-10-12 11:28:17 */
seajs.use(["//misc.360buyimg.com/jdf/1.0.0/unit/globalInit/5.0.0/globalInit","//misc.360buyimg.com/user/quan/3.0.0/widget/header-index/header-index"],function(a,b){a(),b.init(),$("body .p-img").lazyload({type:"img"}),$(".quan-dropdown").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")})});/* user-quan/3.0.0 quan-index.js Date:2017-11-07 16:06:16 */
seajs.use(["//misc.360buyimg.com/jdf/1.0.0/unit/login/1.0.0/login","//misc.360buyimg.com/jdf/1.0.0/ui/switchable/1.0.0/switchable","//misc.360buyimg.com/jdf/2.0.0/ui/ceilinglamp/1.0.0/ceilinglamp","//misc.360buyimg.com/jdf/2.0.0/ui/fixable/1.0.0/fixable","//misc.360buyimg.com/jdf/2.0.0/ui/slider/1.0.0/slider","//misc.360buyimg.com/jdf/1.0.0/unit/trimPath/1.0.0/trimPath","//misc.360buyimg.com/user/quan/3.0.0/widget/quan-index/template","//misc.360buyimg.com/jdf/1.0.0/unit/cookie/1.0.0/cookie","//misc.360buyimg.com/jdf/1.0.0/ui/lazyload/1.0.0/lazyload","//misc.360buyimg.com/jdf/2.0.0/ui/tips/1.0.0/tips","//misc.360buyimg.com/jdf/1.0.0/ui/dialog/1.0.0/dialog"],function(a,b,c,d,e,f,g,h){if(window.category&&window.category.id){var l=category.id||0;var m=category.nextId||0;var n=category.name||"";var o={login:function(b,c){var d=this;var e=b||$.noop;a({modal:!0,complete:function(){d.isLogin=!0,c?location.reload(!0):e()}})}};var p=function(){SYSNAME="a.jd.com",this.init()};p.prototype={init:function(){var b=this;b.giftString="",b.loadFlag=!1,b.endFlag=!1,b.totalNum=0,b.icode="",b.cateId="",b.cateName="",b.page=0,b.clstagObj=null,b.quanTime=null,b.scrollTimer=null,b.batchIds="",b.downTimes=[],0==l?(b.renderwelfareCoupon(),b.renderMarketCoupon(),$(".quan-h-top").show()):$(".quan-h-top").hide(),$(".cate-heading h3").html(n+"\u597d\u5238"),b.renderCateCoupon(1),b.bindEvent(),b.renderMyCount(),b.downTimes=[],$(window).bind("scroll",function(){b.initScrollEvent(b)})},onScrollEle:function(){var a=this;var b=$("#quanlist").offset().top+$("#quanlist").outerHeight(),c=$(document).scrollTop()||0,d=$(window).height()||0;c>=b-d-500&&!a.endFlag&&a.loadFlag&&(a.renderCateCoupon(a.page+1),a.loadFlag=!1)},initScrollEvent:function(a){var b=this;clearTimeout(b.scrollTimer),b.scrollTimer=setTimeout(function(){a.onScrollEle()},200)},renderwelfareCoupon:function(){var b=this;function c(){$.ajax({url:"//a.jd.com/indexAjax/getBannerList.html",dataType:"jsonp",success:function(a){if(a.success){var b=a.bannersList;var c="";c+=g.bannerTpl.process({bannerList:b}),$("#welfare").append(c),$("#focus").switchable({type:"focus",navItem:"s-item",navSelectedClass:"s-selected",contentClass:"s-panel-main",mainClass:"s-panel",autoPlay:!0})}}})}a.isLogin(function(a){a?$.ajax({url:"//a.jd.com/indexAjax/welfareCouponList.html",data:{catalogId:1,page:1,pageSize:10},dataType:"jsonp",success:function(a){if(a.success){var d="";var e=a.welfareCouponList;var f=a.vipCouponList;if(e.length||f.length){var h=[];for(var i=0,j=e.length;j>i;i++){var k=/^\w+$/;e[i].isHasYen=k.test(e[i].denomination)}for(var i=0,j=f.length;j>i;i++){var k=/^\w+$/;f[i].isHasYen=k.test(f[i].denoString),h.push(f[i].batchId)}if(b.batchIds=h.join("#"),a.giftPackageId&&e.length){var l={giftPackageId:a.giftPackageId,giftPackageTitle:a.giftPackageTitle};d+=g.welfareCouponTpl.process({giftList:l,welfareList:e})}else if(a.giftPackageId&&!e.length){var l={giftPackageId:a.giftPackageId,giftPackageTitle:a.giftPackageTitle};d+=g.welfareCouponTpl.process({giftList:l})}else d+=g.welfareCouponTpl.process({welfareList:e});b.giftString+=g.GifeTpl.process({vipCouponList:f}),$("#welfare").removeClass("quan-loading").append(d),$("#welfare .coupon-list").slider({contentEl:".coupon-main ul li",nextEl:$("#welfare .coupon-next"),prevEl:$("#welfare .coupon-prev"),hasOverflow:!0,visible:3})}else c()}}}):c()})},renderGiftCoupon:function(a){var b=this;$.ajax({url:"//a.jd.com/indexAjax/getCoupon.html",data:{key:a,type:3},dataType:"jsonp",success:function(a){if(a.success)$.closeDialog(),$("body").dialog({title:null,width:580,type:"text",fixed:!0,closeButton:!1,mainId:"quan-list-dialog",source:b.giftString,onReady:function(){log(b.clstagObj.pin,b.clstagObj.giftId,b.clstagObj.batchId);$("#quan-list-dialog .coupon-list").slider({contentEl:".content ul li",nextEl:$(".next"),prevEl:$(".prev"),hasOverflow:!0,visible:2})}});else{var c=g.alertErrorMsg.process({msg:a.message});b.alertDlg(c)}}})},renderMarketCoupon:function(){$.ajax({url:"//a.jd.com/indexAjax/market.html",dataType:"jsonp",success:function(a){if(a.success){var b="";b+=g.marketCouponTpl.process(a),$("#marketcoupons").removeClass("quan-loading").append(b)}}})},renderCateCoupon:function(a){var b=this;b.page=a,b.downTimes=[];var c=9;$.ajax({url:"//a.jd.com/indexAjax/getCouponListByCatalogId.html",data:{catalogId:l,page:a,pageSize:c},dataType:"jsonp",success:function(c){if(c.success){b.endFlag=!1,b.totalNum=c.totalNum;var d=c.couponList;var e="";var f=[];if(c.totalNum)for(var h=0,i=d.length;i>h;h++){var j=/^\w+$/;if(d[h].isHasYen=j.test(d[h].denomination),d[h].multDiscount=!1,d[h].discount){d[h].denomination=d[h].denomination.slice(0,-1);var k=$.parseJSON(d[h].extendInfo[19]).info.length;k>1&&(d[h].multDiscount=!0)}if(d[h].leftTime>0){var l={batch:d[h].batchId,remainTime:d[h].leftTime};b.downTimes.push(l)}d[h].discountDetailText||(d[h].discountDetailText=""),f.push(g.couponItemTpl.process({data:$.extend(d[h])}))}1==a&&$("#quanlist").html(""),$(".cate-end").remove(),b.renderWatefallCoupon(f),$("body").lazyload(),$("*[data-tips]").tips({align:["center","bottom"],type:"hover",tipsCls:"prompt-tips",hasClose:!1})}else{var e="";e+=g.couponEmptyTpl,$("#quanlist").removeClass("quan-loading").append(e),$("#quanlist .loading").remove()}}})},renderWatefallCoupon:function(a){var b=this;$("#quanlist .loading").remove(),$(a).map(function(a,b){$("#quanlist").removeClass("quan-loading").append(b)});var c=$("#quanlist .quan-item").length;if(b.totalNum==c){$("#quanlist .loading").remove(),b.endFlag=!0,b.loadFlag=!1;var d="";0!=c?(d+="0"!=m?g.couponNextTpl.process({cateNextId:m}):g.couponEnTpl,$("#quanlist").after(d)):(d+=g.couponEmptyTpl,$("#quanlist").removeClass("quan-loading").append(d))}else b.loadFlag=!0,$("#quanlist").append('<div class="loading"><i class="i1"></i><span class="txt">\u52a0\u8f7d\u4e2d...</span></div>');b.renderTime(),1==b.page&&b.loadFlag&&b.renderCateCoupon(2)},renderTime:function(){var a=this;if(a.downTimes.length)for(var b=0,c=a.downTimes.length;c>b;b++){var d=a.downTimes[b].remainTime;$timeEle=$(".item-"+a.downTimes[b].batch+" .quan-time");var e=a.getRTime(d);$timeEle.html(e),a.reduceTime($timeEle,d)}},reduceTime:function(a,b){var c=this;var d=setInterval(function(){b-=1,timeCont=c.getRTime(b),a.html(timeCont),1>b&&(clearInterval(d),c.changeTime(a))},1e3)},changeTime:function(a){var b=a.parents(".quan-item");b.find(".count-time").hide(),b.find(".hide").not(".q-ops-jump").show(),b.find(".q-ops-box").hide()},addZero:function(a){return 10>a?"0"+a:a},getRTime:function(a){var b=this;Math.floor(a/60/60/24);var d=Math.floor(a/60/60%24);var e=Math.floor(a/60%60);var f=Math.floor(a%60);return str='<span class="t">'+b.addZero(d)+'</span>:<span class="t">'+b.addZero(e)+'</span>:<span class="t">'+b.addZero(f)+"</span>"},renderMyCount:function(){$.ajax({url:"//a.jd.com/indexAjax/myCoupon.html",dataType:"jsonp",success:function(a){if(a.success){var b=a.usableNum;b>99&&(b="99+"),$("#mycoupon").html(b),$("#mycoupon").parents(".num").show()}}})},getDefCoupon:function(a,b,c){var d=this;$.ajax({url:"//a.jd.com/indexAjax/getCoupon.html",data:{key:a,type:b},dataType:"jsonp",success:function(a){if(a.success){var e=g.alertSuccMsg.process({jump:c});$.closeDialog(),$("body").dialog({width:420,type:"text",title:null,autoCloseTime:5,hasButton:!1,source:e,fixed:!0,onReady:function(){if(d.renderMyCount(),d.clstagObj.index?log(d.clstagObj.pin,d.clstagObj.batchId):log(d.clstagObj.pin,d.clstagObj.batchId,d.clstagObj.tabName),2==b)setTimeout(function(){$("#welfare").html(""),d.renderwelfareCoupon()},5e3);else{var a=$(".item-"+d.clstagObj.batchId);a.find(".q-ops-box").hide(),a.find(".q-ops-jump").show(),a.find(".q-progress").hide()}}})}else{var f=g.alertErrorMsg.process({msg:a.message});d.alertDlg(f)}}})},getJrCode:function(a,b,c){var d=this;$.ajax({url:"//a.jd.com/indexAjax/specialCouponRec.html",data:{key:a,type:b,operation:1,captcha:1},type:"GET",dataType:"jsonp",success:function(e){if(e.success){d.icode=e.captcha;var f={key:a,type:b,icode:d.icode,jump:c};var h=g.alertJrForm.process({icodeData:f});$.closeDialog(),$("body").dialog({width:420,type:"text",title:null,mainId:"quan-dialog01",hasButton:!1,fixed:!0,source:h})}else{var h=g.alertErrorMsg.process({msg:e.message});d.alertDlg(h)}}})},getJrCoupon:function(a,b,c,d){var e=this;$.ajax({url:"//a.jd.com/indexAjax/specialCouponRec.html",data:{key:a,type:b,operation:2,captcha:c},type:"GET",dataType:"jsonp",success:function(a){if(a.success){$.closeDialog();var b=g.alertSuccMsg.process({jump:d});$.closeDialog(),$("body").dialog({width:420,type:"text",title:null,autoCloseTime:5,hasButton:!1,fixed:!0,source:b,onReady:function(){e.renderMyCount(),e.clstagObj.index?log(e.clstagObj.pin,e.clstagObj.batchId,e.clstagObj.tabName):log(e.clstagObj.pin,e.clstagObj.batchId,e.clstagObj.tabName);var a=$(".item-"+e.clstagObj.batchId);a.find(".q-ops-box").hide(),a.find(".q-ops-jump").show(),a.find(".q-progress").hide()}})}else if(9999==a.resultCode){var c=a.message;$(".f-tip-wrong").show().find(".tip-text").text(c),$(".icode").attr("src","data:image/png;base64,"+a.captcha),e.icode=a.captcha}else{var f=g.alertErrorMsg.process({msg:a.message});e.alertDlg(f)}}})},getBeanCouponDlg:function(a,b,c,d){var e=this;var f={key:a,type:b,bean:c,jumpUrl:d};$.closeDialog();var h=g.alertBeanMsg.process({beanData:f});e.alertDlg(h)},alertDlg:function(a){$.closeDialog(),$("body").dialog({width:440,type:"text",title:null,mainId:"quan-dialog",fixed:!0,source:a})},bindEvent:function(){var b=this;var c=$(".ui-slidebar-new");c.fixable({x:"right",y:"bottom",xValue:-c.outerWidth()-10,yValue:100,contextEl:$(".quan-h-cate")}),$(".top-slidebar",c).click(function(){scrollTo(0,0)}),$("body").delegate(".gift-btn","click",function(){var a=$(this).attr("rel");b.clstagObj=null,b.renderGiftCoupon(a),b.clstagObj={pin:h("pin"),giftId:a,batchId:b.batchIds}}),$("body").delegate(".btn-def","click",function(){var c=$(this).attr("rel");var d=$(this).data("type");var e=$(this).data("batch");var f=$(this).attr("index");var g=$(this).data("url");a.isLogin(function(a){a?(b.clstagObj=f?{pin:h("pin"),batchId:e,index:f}:{pin:h("pin"),batchId:e,tabName:b.cateName},b.getDefCoupon(c,d,g)):o.login($.noop,!0)})}),$("body").delegate(".btn-jr","click",function(){var c=$(this).attr("rel");var d=$(this).data("type");var e=$(this).data("batch");var f=$(this).attr("index");var g=$(this).data("url");a.isLogin(function(a){a?(b.clstagObj=f?{pin:h("pin"),batchId:e,index:f}:{pin:h("pin"),batchId:e,tabName:b.cateName},b.getJrCode(c,d,g)):o.login($.noop,!0)})}),$("body").delegate(".icode","click",function(){var a=$(this).attr("rel");var c=$(this);$("#icode-itxt").val(""),$.ajax({url:"//a.jd.com/indexAjax/specialCouponRec.html",data:{key:a,type:"white",operation:1,captcha:1},type:"GET",dataType:"jsonp",success:function(a){a.success&&(b.icode=a.captcha,$(".f-tip-wrong").hide(),c.attr("src","data:image/png;base64,"+b.icode))}})}),$("body").delegate(".get-jr-btn","click",function(){var a=$(this).attr("rel");var c=$(this).data("type");var d=$(this).data("url");var e=$(this).parents(".qm-tip2").find("#icode-itxt").val();b.getJrCoupon(a,c,e,d)}),$("body").delegate(".bean-btn","click",function(){var c=$(this).attr("rel");var d=$(this).data("type");var e=$(this).data("bean");var f=$(this).data("batch");var g=$(this).data("url");a.isLogin(function(a){a?(b.clstagObj={pin:h("pin"),batchId:f,tabName:b.cateName},b.getBeanCouponDlg(c,d,e,g)):o.login($.noop,!0)})}),$("body").delegate(".get-bean-btn","click",function(){var a=$(this).attr("rel");var c=$(this).data("type");var d=$(this).data("url");b.getJrCoupon(a,c,null,d)}),$("body").delegate(".get-del","click",function(){$.closeDialog()}),$(".mobile-slidebar").hover(function(){$(this).addClass("mobile-slidebar-hover")},function(){$(this).removeClass("mobile-slidebar-hover")})}};{new p}}});